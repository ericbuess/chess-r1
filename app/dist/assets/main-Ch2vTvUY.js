function Me(b,e){for(var i=0;i<e.length;i++){const n=e[i];if(typeof n!="string"&&!Array.isArray(n)){for(const o in n)if(o!=="default"&&!(o in b)){const a=Object.getOwnPropertyDescriptor(n,o);a&&Object.defineProperty(b,o,a.get?a:{enumerable:!0,get:()=>n[o]})}}}return Object.freeze(Object.defineProperty(b,Symbol.toStringTag,{value:"Module"}))}(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function i(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(o){if(o.ep)return;o.ep=!0;const a=i(o);fetch(o.href,a)}})();var He=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Ge(b){return b&&b.__esModule&&Object.prototype.hasOwnProperty.call(b,"default")?b.default:b}var ve={exports:{}};(function(b,e){(function(i,n){b.exports=n()})(He,function(){return function(i){var n={};function o(a){if(n[a])return n[a].exports;var l=n[a]={i:a,l:!1,exports:{}};return i[a].call(l.exports,l,l.exports,o),l.l=!0,l.exports}return o.m=i,o.c=n,o.d=function(a,l,u){o.o(a,l)||Object.defineProperty(a,l,{enumerable:!0,get:u})},o.r=function(a){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(a,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(a,"__esModule",{value:!0})},o.t=function(a,l){if(1&l&&(a=o(a)),8&l||4&l&&typeof a=="object"&&a&&a.__esModule)return a;var u=Object.create(null);if(o.r(u),Object.defineProperty(u,"default",{enumerable:!0,value:a}),2&l&&typeof a!="string")for(var h in a)o.d(u,h,(function(g){return a[g]}).bind(null,h));return u},o.n=function(a){var l=a&&a.__esModule?function(){return a.default}:function(){return a};return o.d(l,"a",l),l},o.o=function(a,l){return Object.prototype.hasOwnProperty.call(a,l)},o.p="",o(o.s=0)}([function(i,n,o){o.r(n),o.d(n,"Game",function(){return x}),o.d(n,"moves",function(){return Se}),o.d(n,"status",function(){return Ee}),o.d(n,"getFen",function(){return Pe}),o.d(n,"move",function(){return Be}),o.d(n,"aiMove",function(){return ke});const a=["A","B","C","D","E","F","G","H"],l=["1","2","3","4","5","6","7","8"],u={KING_W:"K",QUEEN_W:"Q",ROOK_W:"R",BISHOP_W:"B",KNIGHT_W:"N",PAWN_W:"P",KING_B:"k",QUEEN_B:"q",ROOK_B:"r",BISHOP_B:"b",KNIGHT_B:"n",PAWN_B:"p"},h="black",g="white",m=[0,1,2,3,4],w={0:1,1:2,2:2,3:3,4:3,5:4},E={0:2,1:2,2:4,3:4,4:5,5:5},C={fullMove:1,halfMove:0,enPassant:null,isFinished:!1,checkMate:!1,check:!1,turn:g},k=Object.assign({pieces:{E1:"K",D1:"Q",A1:"R",H1:"R",C1:"B",F1:"B",B1:"N",G1:"N",A2:"P",B2:"P",C2:"P",D2:"P",E2:"P",F2:"P",G2:"P",H2:"P",E8:"k",D8:"q",A8:"r",H8:"r",C8:"b",F8:"b",B8:"n",G8:"n",A7:"p",B7:"p",C7:"p",D7:"p",E7:"p",F7:"p",G7:"p",H7:"p"},castling:{whiteShort:!0,blackShort:!0,whiteLong:!0,blackLong:!0}},C),S={UP:{A1:"A2",A2:"A3",A3:"A4",A4:"A5",A5:"A6",A6:"A7",A7:"A8",A8:null,B1:"B2",B2:"B3",B3:"B4",B4:"B5",B5:"B6",B6:"B7",B7:"B8",B8:null,C1:"C2",C2:"C3",C3:"C4",C4:"C5",C5:"C6",C6:"C7",C7:"C8",C8:null,D1:"D2",D2:"D3",D3:"D4",D4:"D5",D5:"D6",D6:"D7",D7:"D8",D8:null,E1:"E2",E2:"E3",E3:"E4",E4:"E5",E5:"E6",E6:"E7",E7:"E8",E8:null,F1:"F2",F2:"F3",F3:"F4",F4:"F5",F5:"F6",F6:"F7",F7:"F8",F8:null,G1:"G2",G2:"G3",G3:"G4",G4:"G5",G5:"G6",G6:"G7",G7:"G8",G8:null,H1:"H2",H2:"H3",H3:"H4",H4:"H5",H5:"H6",H6:"H7",H7:"H8",H8:null},DOWN:{A1:null,A2:"A1",A3:"A2",A4:"A3",A5:"A4",A6:"A5",A7:"A6",A8:"A7",B1:null,B2:"B1",B3:"B2",B4:"B3",B5:"B4",B6:"B5",B7:"B6",B8:"B7",C1:null,C2:"C1",C3:"C2",C4:"C3",C5:"C4",C6:"C5",C7:"C6",C8:"C7",D1:null,D2:"D1",D3:"D2",D4:"D3",D5:"D4",D6:"D5",D7:"D6",D8:"D7",E1:null,E2:"E1",E3:"E2",E4:"E3",E5:"E4",E6:"E5",E7:"E6",E8:"E7",F1:null,F2:"F1",F3:"F2",F4:"F3",F5:"F4",F6:"F5",F7:"F6",F8:"F7",G1:null,G2:"G1",G3:"G2",G4:"G3",G5:"G4",G6:"G5",G7:"G6",G8:"G7",H1:null,H2:"H1",H3:"H2",H4:"H3",H5:"H4",H6:"H5",H7:"H6",H8:"H7"},LEFT:{A1:null,A2:null,A3:null,A4:null,A5:null,A6:null,A7:null,A8:null,B1:"A1",B2:"A2",B3:"A3",B4:"A4",B5:"A5",B6:"A6",B7:"A7",B8:"A8",C1:"B1",C2:"B2",C3:"B3",C4:"B4",C5:"B5",C6:"B6",C7:"B7",C8:"B8",D1:"C1",D2:"C2",D3:"C3",D4:"C4",D5:"C5",D6:"C6",D7:"C7",D8:"C8",E1:"D1",E2:"D2",E3:"D3",E4:"D4",E5:"D5",E6:"D6",E7:"D7",E8:"D8",F1:"E1",F2:"E2",F3:"E3",F4:"E4",F5:"E5",F6:"E6",F7:"E7",F8:"E8",G1:"F1",G2:"F2",G3:"F3",G4:"F4",G5:"F5",G6:"F6",G7:"F7",G8:"F8",H1:"G1",H2:"G2",H3:"G3",H4:"G4",H5:"G5",H6:"G6",H7:"G7",H8:"G8"},RIGHT:{A1:"B1",A2:"B2",A3:"B3",A4:"B4",A5:"B5",A6:"B6",A7:"B7",A8:"B8",B1:"C1",B2:"C2",B3:"C3",B4:"C4",B5:"C5",B6:"C6",B7:"C7",B8:"C8",C1:"D1",C2:"D2",C3:"D3",C4:"D4",C5:"D5",C6:"D6",C7:"D7",C8:"D8",D1:"E1",D2:"E2",D3:"E3",D4:"E4",D5:"E5",D6:"E6",D7:"E7",D8:"E8",E1:"F1",E2:"F2",E3:"F3",E4:"F4",E5:"F5",E6:"F6",E7:"F7",E8:"F8",F1:"G1",F2:"G2",F3:"G3",F4:"G4",F5:"G5",F6:"G6",F7:"G7",F8:"G8",G1:"H1",G2:"H2",G3:"H3",G4:"H4",G5:"H5",G6:"H6",G7:"H7",G8:"H8",H1:null,H2:null,H3:null,H4:null,H5:null,H6:null,H7:null,H8:null},UP_LEFT:{A1:null,A2:null,A3:null,A4:null,A5:null,A6:null,A7:null,A8:null,B1:"A2",B2:"A3",B3:"A4",B4:"A5",B5:"A6",B6:"A7",B7:"A8",B8:null,C1:"B2",C2:"B3",C3:"B4",C4:"B5",C5:"B6",C6:"B7",C7:"B8",C8:null,D1:"C2",D2:"C3",D3:"C4",D4:"C5",D5:"C6",D6:"C7",D7:"C8",D8:null,E1:"D2",E2:"D3",E3:"D4",E4:"D5",E5:"D6",E6:"D7",E7:"D8",E8:null,F1:"E2",F2:"E3",F3:"E4",F4:"E5",F5:"E6",F6:"E7",F7:"E8",F8:null,G1:"F2",G2:"F3",G3:"F4",G4:"F5",G5:"F6",G6:"F7",G7:"F8",G8:null,H1:"G2",H2:"G3",H3:"G4",H4:"G5",H5:"G6",H6:"G7",H7:"G8",H8:null},DOWN_RIGHT:{A1:null,A2:"B1",A3:"B2",A4:"B3",A5:"B4",A6:"B5",A7:"B6",A8:"B7",B1:null,B2:"C1",B3:"C2",B4:"C3",B5:"C4",B6:"C5",B7:"C6",B8:"C7",C1:null,C2:"D1",C3:"D2",C4:"D3",C5:"D4",C6:"D5",C7:"D6",C8:"D7",D1:null,D2:"E1",D3:"E2",D4:"E3",D5:"E4",D6:"E5",D7:"E6",D8:"E7",E1:null,E2:"F1",E3:"F2",E4:"F3",E5:"F4",E6:"F5",E7:"F6",E8:"F7",F1:null,F2:"G1",F3:"G2",F4:"G3",F5:"G4",F6:"G5",F7:"G6",F8:"G7",G1:null,G2:"H1",G3:"H2",G4:"H3",G5:"H4",G6:"H5",G7:"H6",G8:"H7",H1:null,H2:null,H3:null,H4:null,H5:null,H6:null,H7:null,H8:null},UP_RIGHT:{A1:"B2",A2:"B3",A3:"B4",A4:"B5",A5:"B6",A6:"B7",A7:"B8",A8:null,B1:"C2",B2:"C3",B3:"C4",B4:"C5",B5:"C6",B6:"C7",B7:"C8",B8:null,C1:"D2",C2:"D3",C3:"D4",C4:"D5",C5:"D6",C6:"D7",C7:"D8",C8:null,D1:"E2",D2:"E3",D3:"E4",D4:"E5",D5:"E6",D6:"E7",D7:"E8",D8:null,E1:"F2",E2:"F3",E3:"F4",E4:"F5",E5:"F6",E6:"F7",E7:"F8",E8:null,F1:"G2",F2:"G3",F3:"G4",F4:"G5",F5:"G6",F6:"G7",F7:"G8",F8:null,G1:"H2",G2:"H3",G3:"H4",G4:"H5",G5:"H6",G6:"H7",G7:"H8",G8:null,H1:null,H2:null,H3:null,H4:null,H5:null,H6:null,H7:null,H8:null},DOWN_LEFT:{A1:null,A2:null,A3:null,A4:null,A5:null,A6:null,A7:null,A8:null,B1:null,B2:"A1",B3:"A2",B4:"A3",B5:"A4",B6:"A5",B7:"A6",B8:"A7",C1:null,C2:"B1",C3:"B2",C4:"B3",C5:"B4",C6:"B5",C7:"B6",C8:"B7",D1:null,D2:"C1",D3:"C2",D4:"C3",D5:"C4",D6:"C5",D7:"C6",D8:"C7",E1:null,E2:"D1",E3:"D2",E4:"D3",E5:"D4",E6:"D5",E7:"D6",E8:"D7",F1:null,F2:"E1",F3:"E2",F4:"E3",F5:"E4",F6:"E5",F7:"E6",F8:"E7",G1:null,G2:"F1",G3:"F2",G4:"F3",G5:"F4",G6:"F5",G7:"F6",G8:"F7",H1:null,H2:"G1",H3:"G2",H4:"G3",H5:"G4",H6:"G5",H7:"G6",H8:"G7"}},M=[[0,0,0,0,0,0,0,0],[5,5,5,5,5,5,5,5],[1,1,2,3,3,2,1,1],[.5,.5,1,2.5,2.5,1,.5,.5],[0,0,0,2,2,0,0,0],[.5,0,1,0,0,1,0,.5],[.5,0,0,-2,-2,0,0,.5],[0,0,0,0,0,0,0,0]],G=[[-4,-3,-2,-2,-2,-2,-3,-4],[-3,-2,0,0,0,0,-2,-3],[-2,0,1,1.5,1.5,1,0,-2],[-2,.5,1.5,2,2,1.5,.5,-2],[-2,0,1.5,2,2,1.5,0,-2],[-2,.5,1,1.5,1.5,1,.5,-2],[-3,-2,0,.5,.5,0,-2,-3],[-4,-3,-2,-2,-2,-2,-3,-4]],I=[[-2,-1,-1,-1,-1,-1,-1,-2],[-1,0,0,0,0,0,0,-1],[-1,0,.5,1,1,.5,0,-1],[-1,.5,.5,1,1,.5,.5,-1],[-1,0,1,1,1,1,0,-1],[-1,1,1,1,1,1,1,-1],[-1,.5,0,0,0,0,.5,-1],[-2,-1,-1,-1,-1,-1,-1,-2]],Q=[[0,0,0,0,0,0,0,0],[.5,1,1,1,1,1,1,.5],[-.5,0,0,0,0,0,0,-.5],[-.5,0,0,0,0,0,0,-.5],[-.5,0,0,0,0,0,0,-.5],[-.5,0,0,0,0,0,0,-.5],[-.5,0,0,0,0,0,0,-.5],[0,0,0,.5,.5,0,0,0]],q=[[-3,-4,-4,-5,-5,-4,-4,-3],[-3,-4,-4,-5,-5,-4,-4,-3],[-3,-4,-4,-5,-5,-4,-4,-3],[-3,-4,-4,-5,-5,-4,-4,-3],[-2,-3,-3,-4,-4,-3,-3,-2],[-1,-2,-2,-2,-2,-2,-2,-1],[2,2,0,0,0,0,2,2],[2,3,1,0,0,1,3,2]],ie=[[-2,-1,-1,-.5,-.5,-1,-1,-2],[-1,0,0,0,0,0,0,-1],[-1,0,.5,.5,.5,.5,0,-1],[-.5,0,.5,.5,.5,.5,0,-.5],[0,0,.5,.5,.5,.5,0,-.5],[-1,.5,.5,.5,.5,.5,0,-1],[-1,0,.5,0,0,0,0,-1],[-2,-1,-1,-.5,-.5,-1,-1,-2]],se={P:M.slice().reverse(),p:M,N:G.slice().reverse(),n:G,B:I.slice().reverse(),b:I,R:Q.slice().reverse(),r:Q,K:q.slice().reverse(),k:q,Q:ie.slice().reverse(),q:ie};function L(y){return S.UP[y]}function O(y){return S.DOWN[y]}function T(y){return S.LEFT[y]}function F(y){return S.RIGHT[y]}function R(y){return S.UP_LEFT[y]}function _(y){return S.UP_RIGHT[y]}function U(y){return S.DOWN_LEFT[y]}function j(y){return S.DOWN_RIGHT[y]}function ne(y){const s=R(y);return s?L(s):null}function oe(y){const s=R(y);return s?T(s):null}function ae(y){const s=_(y);return s?L(s):null}function re(y){const s=_(y);return s?F(s):null}function le(y){const s=U(y);return s?O(s):null}function ce(y){const s=U(y);return s?T(s):null}function ue(y){const s=j(y);return s?O(s):null}function he(y){const s=j(y);return s?F(s):null}function de(y,s){return s===g?S.UP[y]:S.DOWN[y]}function z(y,s){return s===g?S.UP_LEFT[y]:S.DOWN_RIGHT[y]}function X(y,s){return s===g?S.UP_RIGHT[y]:S.DOWN_LEFT[y]}function ge(y,s){return s===g?S.DOWN_LEFT[y]:S.UP_RIGHT[y]}function me(y,s){return s===g?S.DOWN_RIGHT[y]:S.UP_LEFT[y]}function $(y){return{k:10,q:9,r:5,b:3,n:3,p:1}[y.toLowerCase()]||0}function V(y){return typeof y=="string"&&y.match("^[a-hA-H]{1}[1-8]{1}$")}const Z=-1e3,ee=1e3;class Y{constructor(s=JSON.parse(JSON.stringify(k))){if(typeof s=="object")this.configuration=Object.assign({},C,s);else{if(typeof s!="string")throw new Error(`Unknown configuration type ${typeof config}.`);this.configuration=Object.assign({},C,function(r=""){const[c,d,t,p,v,f]=r.split(" "),H={pieces:Object.fromEntries(c.split("/").flatMap((D,K)=>{let A=0;return D.split("").reduce((J,N)=>{const fe=N.match(/k|b|q|n|p|r/i);fe&&(J.push([`${a[A]}${l[7-K]}`,fe[0]]),A+=1);const pe=N.match(/[1-8]/);return pe&&(A+=Number(pe)),J},[])}))};return H.turn=d==="b"?h:g,H.castling={whiteLong:!1,whiteShort:!1,blackLong:!1,blackShort:!1},t.includes("K")&&(H.castling.whiteShort=!0),t.includes("k")&&(H.castling.blackShort=!0),t.includes("Q")&&(H.castling.whiteLong=!0),t.includes("q")&&(H.castling.blackLong=!0),V(p)&&(H.enPassant=p.toUpperCase()),H.halfMove=parseInt(v),H.fullMove=parseInt(f),H}(s))}this.configuration.castling||(this.configuration.castling={whiteShort:!0,blackShort:!0,whiteLong:!0,blackLong:!0}),this.history=[]}getAttackingFields(s=this.getPlayingColor()){let r=[];for(const c in this.configuration.pieces){const d=this.getPiece(c);this.getPieceColor(d)===s&&(r=[...r,...this.getPieceMoves(d,c)])}return r}isAttackingKing(s=this.getPlayingColor()){let r=null;for(const c in this.configuration.pieces){const d=this.getPiece(c);if(this.isKing(d)&&this.getPieceColor(d)!==s){r=c;break}}return this.isPieceUnderAttack(r)}isPieceUnderAttack(s){const r=this.getPieceOnLocationColor(s),c=this.getEnemyColor(r);let d=!1,t=s,p=0;for(;L(t)&&!d;){t=L(t),p++;const f=this.getPiece(t);if(f&&this.getPieceColor(f)===c&&(this.isRook(f)||this.isQueen(f)||this.isKing(f)&&p===1)&&(d=!0),f)break}for(t=s,p=0;O(t)&&!d;){t=O(t),p++;const f=this.getPiece(t);if(f&&this.getPieceColor(f)===c&&(this.isRook(f)||this.isQueen(f)||this.isKing(f)&&p===1)&&(d=!0),f)break}for(t=s,p=0;T(t)&&!d;){t=T(t),p++;const f=this.getPiece(t);if(f&&this.getPieceColor(f)===c&&(this.isRook(f)||this.isQueen(f)||this.isKing(f)&&p===1)&&(d=!0),f)break}for(t=s,p=0;F(t)&&!d;){t=F(t),p++;const f=this.getPiece(t);if(f&&this.getPieceColor(f)===c&&(this.isRook(f)||this.isQueen(f)||this.isKing(f)&&p===1)&&(d=!0),f)break}for(t=s,p=0;X(t,r)&&!d;){t=X(t,r),p++;const f=this.getPiece(t);if(f&&this.getPieceColor(f)===c&&(this.isBishop(f)||this.isQueen(f)||p===1&&(this.isKing(f)||this.isPawn(f)))&&(d=!0),f)break}for(t=s,p=0;z(t,r)&&!d;){t=z(t,r),p++;const f=this.getPiece(t);if(f&&this.getPieceColor(f)===c&&(this.isBishop(f)||this.isQueen(f)||p===1&&(this.isKing(f)||this.isPawn(f)))&&(d=!0),f)break}for(t=s,p=0;me(t,r)&&!d;){t=me(t,r),p++;const f=this.getPiece(t);if(f&&this.getPieceColor(f)===c&&(this.isBishop(f)||this.isQueen(f)||this.isKing(f)&&p===1)&&(d=!0),f)break}for(t=s,p=0;ge(t,r)&&!d;){t=ge(t,r),p++;const f=this.getPiece(t);if(f&&this.getPieceColor(f)===c&&(this.isBishop(f)||this.isQueen(f)||this.isKing(f)&&p===1)&&(d=!0),f)break}t=ae(s);let v=this.getPiece(t);return v&&this.getPieceColor(v)===c&&this.isKnight(v)&&(d=!0),t=re(s),v=this.getPiece(t),v&&this.getPieceColor(v)===c&&this.isKnight(v)&&(d=!0),t=oe(s),v=this.getPiece(t),v&&this.getPieceColor(v)===c&&this.isKnight(v)&&(d=!0),t=ne(s),v=this.getPiece(t),v&&this.getPieceColor(v)===c&&this.isKnight(v)&&(d=!0),t=le(s),v=this.getPiece(t),v&&this.getPieceColor(v)===c&&this.isKnight(v)&&(d=!0),t=ce(s),v=this.getPiece(t),v&&this.getPieceColor(v)===c&&this.isKnight(v)&&(d=!0),t=ue(s),v=this.getPiece(t),v&&this.getPieceColor(v)===c&&this.isKnight(v)&&(d=!0),t=he(s),v=this.getPiece(t),v&&this.getPieceColor(v)===c&&this.isKnight(v)&&(d=!0),d}hasPlayingPlayerCheck(){return this.isAttackingKing(this.getNonPlayingColor())}hasNonPlayingPlayerCheck(){return this.isAttackingKing(this.getPlayingColor())}getLowestValuePieceAttackingLocation(s,r=this.getPlayingColor()){let c=null;for(const d in this.configuration.pieces){const t=this.getPiece(d);this.getPieceColor(t)===r&&this.getPieceMoves(t,d).map(p=>{p===s&&(c===null||$(t)<c)&&(c=$(t))})}return c}getMoves(s=this.getPlayingColor(),r=null){const c={};let d=0;for(const v in this.configuration.pieces){const f=this.getPiece(v);if(this.getPieceColor(f)===s){const H=this.getPieceMoves(f,v);H.length&&d++,Object.assign(c,{[v]:H})}}const t=this.getAttackingFields(this.getNonPlayingColor());if(this.isLeftCastlingPossible(t)&&(this.isPlayingWhite()&&c.E1.push("C1"),this.isPlayingBlack()&&c.E8.push("C8")),this.isRightCastlingPossible(t)&&(this.isPlayingWhite()&&c.E1.push("G1"),this.isPlayingBlack()&&c.E8.push("G8")),r&&d>r)return c;const p={};for(const v in c)c[v].map(f=>{const H={pieces:Object.assign({},this.configuration.pieces),castling:Object.assign({},this.configuration.castling)},D=new Y(H);D.move(v,f),(this.isPlayingWhite()&&!D.isAttackingKing(h)||this.isPlayingBlack()&&!D.isAttackingKing(g))&&(p[v]||(p[v]=[]),p[v].push(f))});return Object.keys(p).length||(this.configuration.isFinished=!0,this.hasPlayingPlayerCheck()&&(this.configuration.checkMate=!0)),p}isLeftCastlingPossible(s){if(this.isPlayingWhite()&&!this.configuration.castling.whiteLong||this.isPlayingBlack()&&!this.configuration.castling.blackLong)return!1;let r=null;if(this.isPlayingWhite()&&this.getPiece("E1")==="K"&&this.getPiece("A1")==="R"&&!s.includes("E1")?r="E1":this.isPlayingBlack()&&this.getPiece("E8")==="k"&&this.getPiece("A8")==="r"&&!s.includes("E8")&&(r="E8"),!r)return!1;let c=T(r);return!this.getPiece(c)&&!s.includes(c)&&(c=T(c),!this.getPiece(c)&&!s.includes(c)&&(c=T(c),!this.getPiece(c)))}isRightCastlingPossible(s){if(this.isPlayingWhite()&&!this.configuration.castling.whiteShort||this.isPlayingBlack()&&!this.configuration.castling.blackShort)return!1;let r=null;if(this.isPlayingWhite()&&this.getPiece("E1")==="K"&&this.getPiece("H1")==="R"&&!s.includes("E1")?r="E1":this.isPlayingBlack()&&this.getPiece("E8")==="k"&&this.getPiece("H8")==="r"&&!s.includes("E8")&&(r="E8"),!r)return!1;let c=F(r);return!this.getPiece(c)&&!s.includes(c)&&(c=F(c),!this.getPiece(c)&&!s.includes(c))}getPieceMoves(s,r){return this.isPawn(s)?this.getPawnMoves(s,r):this.isKnight(s)?this.getKnightMoves(s,r):this.isRook(s)?this.getRookMoves(s,r):this.isBishop(s)?this.getBishopMoves(s,r):this.isQueen(s)?this.getQueenMoves(s,r):this.isKing(s)?this.getKingMoves(s,r):[]}isPawn(s){return s.toUpperCase()==="P"}isKnight(s){return s.toUpperCase()==="N"}isRook(s){return s.toUpperCase()==="R"}isBishop(s){return s.toUpperCase()==="B"}isQueen(s){return s.toUpperCase()==="Q"}isKing(s){return s.toUpperCase()==="K"}getPawnMoves(s,r){const c=[],d=this.getPieceColor(s);let t=de(r,d);return t&&!this.getPiece(t)&&(c.push(t),t=de(t,d),function(p,v){return p===g&&v[1]==="2"||p===h&&v[1]==="7"}(d,r)&&t&&!this.getPiece(t)&&c.push(t)),t=z(r,d),t&&(this.getPiece(t)&&this.getPieceOnLocationColor(t)!==d||t===this.configuration.enPassant)&&c.push(t),t=X(r,d),t&&(this.getPiece(t)&&this.getPieceOnLocationColor(t)!==d||t===this.configuration.enPassant)&&c.push(t),c}getKnightMoves(s,r){const c=[],d=this.getPieceColor(s);let t=ae(r);return t&&this.getPieceOnLocationColor(t)!==d&&c.push(t),t=re(r),t&&this.getPieceOnLocationColor(t)!==d&&c.push(t),t=ne(r),t&&this.getPieceOnLocationColor(t)!==d&&c.push(t),t=oe(r),t&&this.getPieceOnLocationColor(t)!==d&&c.push(t),t=ce(r),t&&this.getPieceOnLocationColor(t)!==d&&c.push(t),t=le(r),t&&this.getPieceOnLocationColor(t)!==d&&c.push(t),t=he(r),t&&this.getPieceOnLocationColor(t)!==d&&c.push(t),t=ue(r),t&&this.getPieceOnLocationColor(t)!==d&&c.push(t),c}getRookMoves(s,r){const c=[],d=this.getPieceColor(s);let t=r;for(;L(t);){t=L(t);const p=this.getPieceOnLocationColor(t);if(this.getPieceOnLocationColor(t)!==d&&c.push(t),p)break}for(t=r;O(t);){t=O(t);const p=this.getPieceOnLocationColor(t);if(this.getPieceOnLocationColor(t)!==d&&c.push(t),p)break}for(t=r;F(t);){t=F(t);const p=this.getPieceOnLocationColor(t);if(this.getPieceOnLocationColor(t)!==d&&c.push(t),p)break}for(t=r;T(t);){t=T(t);const p=this.getPieceOnLocationColor(t);if(this.getPieceOnLocationColor(t)!==d&&c.push(t),p)break}return c}getBishopMoves(s,r){const c=[],d=this.getPieceColor(s);let t=r;for(;R(t);){t=R(t);const p=this.getPieceOnLocationColor(t);if(this.getPieceOnLocationColor(t)!==d&&c.push(t),p)break}for(t=r;_(t);){t=_(t);const p=this.getPieceOnLocationColor(t);if(this.getPieceOnLocationColor(t)!==d&&c.push(t),p)break}for(t=r;U(t);){t=U(t);const p=this.getPieceOnLocationColor(t);if(this.getPieceOnLocationColor(t)!==d&&c.push(t),p)break}for(t=r;j(t);){t=j(t);const p=this.getPieceOnLocationColor(t);if(this.getPieceOnLocationColor(t)!==d&&c.push(t),p)break}return c}getQueenMoves(s,r){return[...this.getRookMoves(s,r),...this.getBishopMoves(s,r)]}getKingMoves(s,r){const c=[],d=this.getPieceColor(s);let t=r;return t=L(t),t&&this.getPieceOnLocationColor(t)!==d&&c.push(t),t=r,t=F(t),t&&this.getPieceOnLocationColor(t)!==d&&c.push(t),t=r,t=O(t),t&&this.getPieceOnLocationColor(t)!==d&&c.push(t),t=r,t=T(t),t&&this.getPieceOnLocationColor(t)!==d&&c.push(t),t=r,t=R(t),t&&this.getPieceOnLocationColor(t)!==d&&c.push(t),t=r,t=_(t),t&&this.getPieceOnLocationColor(t)!==d&&c.push(t),t=r,t=U(t),t&&this.getPieceOnLocationColor(t)!==d&&c.push(t),t=r,t=j(t),t&&this.getPieceOnLocationColor(t)!==d&&c.push(t),c}getPieceColor(s){return s.toUpperCase()===s?g:h}getPieceOnLocationColor(s){const r=this.getPiece(s);return r?r.toUpperCase()===r?g:h:null}getPiece(s){return this.configuration.pieces[s]}setPiece(s,r){if(!function(c){return Object.values(u).includes(c)}(r))throw new Error("Invalid piece "+r);if(!V(s))throw new Error("Invalid location "+s);this.configuration.pieces[s.toUpperCase()]=r}removePiece(s){if(!V(s))throw new Error("Invalid location "+s);delete this.configuration.pieces[s.toUpperCase()]}isEmpty(s){if(!V(s))throw new Error("Invalid location "+s);return!this.configuration.pieces[s.toUpperCase()]}getEnemyColor(s){return s===g?h:g}getPlayingColor(){return this.configuration.turn}getNonPlayingColor(){return this.isPlayingWhite()?h:g}isPlayingWhite(){return this.configuration.turn===g}isPlayingBlack(){return this.configuration.turn===h}addMoveToHistory(s,r){this.history.push({from:s,to:r,configuration:JSON.parse(JSON.stringify(this.configuration))})}move(s,r){const c=this.getPiece(s),d=this.getPiece(r);if(!c)throw new Error("There is no piece at "+s);var t,p;if(Object.assign(this.configuration.pieces,{[r]:c}),delete this.configuration.pieces[s],this.isPlayingWhite()&&this.isPawn(c)&&r[1]==="8"&&Object.assign(this.configuration.pieces,{[r]:"Q"}),this.isPlayingBlack()&&this.isPawn(c)&&r[1]==="1"&&Object.assign(this.configuration.pieces,{[r]:"q"}),this.isPawn(c)&&r===this.configuration.enPassant&&delete this.configuration.pieces[t=r,p=this.getPlayingColor(),p===g?S.DOWN[t]:S.UP[t]],this.isPawn(c)&&this.isPlayingWhite()&&s[1]==="2"&&r[1]==="4"?this.configuration.enPassant=s[0]+"3":this.isPawn(c)&&this.isPlayingBlack()&&s[1]==="7"&&r[1]==="5"?this.configuration.enPassant=s[0]+"6":this.configuration.enPassant=null,s==="E1"&&Object.assign(this.configuration.castling,{whiteLong:!1,whiteShort:!1}),s==="E8"&&Object.assign(this.configuration.castling,{blackLong:!1,blackShort:!1}),s==="A1"&&Object.assign(this.configuration.castling,{whiteLong:!1}),s==="H1"&&Object.assign(this.configuration.castling,{whiteShort:!1}),s==="A8"&&Object.assign(this.configuration.castling,{blackLong:!1}),s==="H8"&&Object.assign(this.configuration.castling,{blackShort:!1}),this.isKing(c)){if(s==="E1"&&r==="C1")return this.move("A1","D1");if(s==="E8"&&r==="C8")return this.move("A8","D8");if(s==="E1"&&r==="G1")return this.move("H1","F1");if(s==="E8"&&r==="G8")return this.move("H8","F8")}this.configuration.turn=this.isPlayingWhite()?h:g,this.isPlayingWhite()&&this.configuration.fullMove++,this.configuration.halfMove++,(d||this.isPawn(c))&&(this.configuration.halfMove=0)}exportJson(){return{moves:this.getMoves(),pieces:this.configuration.pieces,turn:this.configuration.turn,isFinished:this.configuration.isFinished,check:this.hasPlayingPlayerCheck(),checkMate:this.configuration.checkMate,castling:this.configuration.castling,enPassant:this.configuration.enPassant,halfMove:this.configuration.halfMove,fullMove:this.configuration.fullMove}}calculateAiMove(s){return this.calculateAiMoves(s)[0]}calculateAiMoves(s){if(s=parseInt(s),!m.includes(s))throw new Error(`Invalid level ${s}. You can choose ${m.join(",")}`);this.shouldIncreaseLevel()&&s++;const r=[],c=this.calculateScore(this.getPlayingColor()),d=this.getMoves();for(const t in d)d[t].map(p=>{const v=this.getTestBoard(),f=!!v.getPiece(p);v.move(t,p),r.push({from:t,to:p,score:v.testMoveScores(this.getPlayingColor(),s,f,f?v.calculateScore(this.getPlayingColor()):c,p).score+v.calculateScoreByPiecesLocation(this.getPlayingColor())+Math.floor(Math.random()*(this.configuration.halfMove>10?this.configuration.halfMove-10:1)*10)/10})});return r.sort((t,p)=>t.score<p.score?1:t.score>p.score?-1:0),r}shouldIncreaseLevel(){return this.getIngamePiecesValue()<50}getIngamePiecesValue(){let s=0;for(const r in this.configuration.pieces)s+=$(this.getPiece(r));return s}getTestBoard(){const s={pieces:Object.assign({},this.configuration.pieces),castling:Object.assign({},this.configuration.castling),turn:this.configuration.turn,enPassant:this.configuration.enPassant};return new Y(s)}testMoveScores(s,r,c,d,t,p=1){let v=null;if(p<E[r]&&this.hasPlayingPlayerCheck()?v=this.getMoves(this.getPlayingColor()):(p<w[r]||c&&p<E[r])&&(v=this.getMoves(this.getPlayingColor(),5)),this.configuration.isFinished)return{score:this.calculateScore(s)+(this.getPlayingColor()===s?p:-p),max:!0};if(!v)return d!==null?{score:d,max:!1}:{score:this.calculateScore(s),max:!1};let f=this.getPlayingColor()===s?Z:ee,H=!1;for(const D in v)H||v[D].map(K=>{if(H)return;const A=this.getTestBoard(),J=!!A.getPiece(K);if(A.move(D,K),A.hasNonPlayingPlayerCheck())return;const N=A.testMoveScores(s,r,J,J?A.calculateScore(s):d,K,p+1);N.max&&(H=!0),f=this.getPlayingColor()===s?Math.max(f,N.score):Math.min(f,N.score)});return{score:f,max:!1}}calculateScoreByPiecesLocation(s=this.getPlayingColor()){const r={A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7};let c=0;for(const d in this.configuration.pieces){const t=this.getPiece(d);if(se[t]){const p=se[t][d[1]-1][r[d[0]]];c+=.5*(this.getPieceColor(t)===s?p:-p)}}return c}calculateScore(s=this.getPlayingColor()){let r=0;if(this.configuration.checkMate)return this.getPlayingColor()===s?Z:ee;if(this.configuration.isFinished)return this.getPlayingColor()===s?ee:Z;for(const c in this.configuration.pieces){const d=this.getPiece(c);this.getPieceColor(d)===s?r+=10*$(d):r-=10*$(d)}return r}}class x{constructor(s){this.board=new Y(s)}move(s,r){s=s.toUpperCase(),r=r.toUpperCase();const c=this.board.getMoves();if(!c[s]||!c[s].includes(r))throw new Error(`Invalid move from ${s} to ${r} for ${this.board.getPlayingColor()}`);return this.board.addMoveToHistory(s,r),this.board.move(s,r),{[s]:r}}moves(s=null){return(s?this.board.getMoves()[s.toUpperCase()]:this.board.getMoves())||[]}setPiece(s,r){this.board.setPiece(s,r)}removePiece(s){this.board.removePiece(s)}aiMove(s=2){const r=this.board.calculateAiMove(s);return this.move(r.from,r.to)}getHistory(s=!1){return s?this.board.history.reverse():this.board.history}printToConsole(){(function(s){process.stdout.write(`
`);let r=g;Object.assign([],l).reverse().map(c=>{process.stdout.write(""+c),a.map(d=>{switch(s.pieces[`${d}${c}`]){case"K":process.stdout.write("♚");break;case"Q":process.stdout.write("♛");break;case"R":process.stdout.write("♜");break;case"B":process.stdout.write("♝");break;case"N":process.stdout.write("♞");break;case"P":process.stdout.write("♟");break;case"k":process.stdout.write("♔");break;case"q":process.stdout.write("♕");break;case"r":process.stdout.write("♖");break;case"b":process.stdout.write("♗");break;case"n":process.stdout.write("♘");break;case"p":process.stdout.write("♙");break;default:process.stdout.write(r===g?"█":"░")}r=r===g?h:g}),r=r===g?h:g,process.stdout.write(`
`)}),process.stdout.write(" "),a.map(c=>{process.stdout.write(""+c)}),process.stdout.write(`
`)})(this.board.configuration)}exportJson(){return this.board.exportJson()}exportFEN(){return function(s){let r="";Object.assign([],l).reverse().map(v=>{let f=0;v<8&&(r+="/"),a.map(H=>{const D=s.pieces[`${H}${v}`];D?(f&&(r+=f.toString(),f=0),r+=D):f++}),r+=""+(f||"")}),r+=s.turn===g?" w ":" b ";const{whiteShort:c,whiteLong:d,blackLong:t,blackShort:p}=s.castling;return d||c||t||p?(c&&(r+="K"),d&&(r+="Q"),p&&(r+="k"),t&&(r+="q")):r+="-",r+=" "+(s.enPassant?s.enPassant.toLowerCase():"-"),r+=" "+s.halfMove,r+=" "+s.fullMove,r}(this.board.configuration)}}function Se(y){if(!y)throw new Error("Configuration param required.");return new x(y).moves()}function Ee(y){if(!y)throw new Error("Configuration param required.");return new x(y).exportJson()}function Pe(y){if(!y)throw new Error("Configuration param required.");return new x(y).exportFEN()}function Be(y,s,r){if(!y)throw new Error("Configuration param required.");const c=new x(y);return c.move(s,r),typeof y=="object"?c.exportJson():c.exportFEN()}function ke(y,s=2){if(!y)throw new Error("Configuration param required.");const r=new x(y).board.calculateAiMove(s);return{[r.from]:r.to}}}])})})(ve);var Ce=ve.exports;const Ie=Ge(Ce),be=Me({__proto__:null,default:Ie},[Ce]);window.jsChessEngine=be;console.log("Chess engine modules:",Object.keys(be));class De{constructor(){this.engine=new window.jsChessEngine.Game,this.selectedSquare=null,this.possibleMoves=[],this.boardFlipped=!1,this.orientationMode="handoff",this.gameMode="human-vs-bot",this.humanColor="white",this.botDifficulty=1,this.allowUndo=!0,this.soundEnabled=!0,this.originalGameMode="human-vs-bot",this.originalHumanColor="white",this.colorChangedMidGame=!1,this.originalBotDifficulty=1,this.difficultyChangedMidGame=!1,this.board=this.engineStateToBoard(),this.currentPlayer="white",this.gameStatus="playing",this.stateHistory=[],this.currentStateIndex=0,this.isInUndoRedoState=!1,this.lastUndoWasBotMove=!1,this.moveHistory=[];const e=this.engine.exportJson();this.stateHistory.push({engineState:JSON.parse(JSON.stringify(e)),move:null,notation:null,timestamp:Date.now()}),this.sounds=this.createSoundSystem(),this.checkDepth=0,this.checkOperations=0,this.maxCheckDepth=10,this.maxCheckOperations=1e3,this.isEndgameDetection=!1,this.castlingRights={white:{kingside:!0,queenside:!0},black:{kingside:!0,queenside:!0}},this.enPassantTarget=null}async makeMove(e,i,n,o){const a=this.coordsToSquare(e,i),l=this.coordsToSquare(n,o);try{const u=this.board[n][o],h=u!==null,g=this.board[e][i],m=this.engine.move(a,l);this.updateCachedState(),this.boardFlipped=this.determineOrientation();const w=this.updateGameStatus();if(w){const k=this.currentPlayer==="white"?"White":"Black"}const E=this.generateMoveNotation(e,i,n,o,g,u,this.gameStatus==="check",this.gameStatus==="checkmate"),C=this.generateMoveCommentary(e,i,n,o,g,u,null);return this.recordGameState({from:{row:e,col:i},to:{row:n,col:o},piece:g,captured:u,notation:E,commentary:C}),h?this.playSound("capture"):this.playSound("move"),this.gameStatus==="checkmate"?setTimeout(()=>this.playSound("checkmate"),h?100:0):this.gameStatus==="check"&&setTimeout(()=>this.playSound("check"),h?100:0),await this.autoSave(),{success:!0,enteredCheck:w}}catch{return{success:!1,enteredCheck:!1}}}getPossibleMoves(e,i){const n=this.coordsToSquare(e,i),o=this.engine.moves(n);return!o||o.length===0?[]:o.map(a=>{const l=this.squareToCoords(a);return{row:l.row,col:l.col}})}updateGameStatus(){const e=this.engine.exportJson(),i=this.gameStatus;return e.checkMate?this.gameStatus="checkmate":e.isFinished&&!e.checkMate?this.gameStatus="stalemate":e.check?this.gameStatus="check":this.gameStatus="playing",i!=="check"&&this.gameStatus==="check"}updateCachedState(){const e=this.engine.exportJson();this.board=this.engineStateToBoard(),this.currentPlayer,this.currentPlayer=e.turn,this.castlingRights={white:{kingside:e.castling.whiteShort,queenside:e.castling.whiteLong},black:{kingside:e.castling.blackShort,queenside:e.castling.blackLong}},this.enPassantTarget=e.enPassant}isBotTurn(){return this.gameMode==="human-vs-human"?!1:this.currentPlayer!==this.humanColor}async generateBotMove(){try{const e=this.board,i=this.engine.aiMove(this.botDifficulty);this.updateCachedState();const n=this.updateGameStatus(),o=Object.entries(i);if(o.length>0){const[a,l]=o[0],u=this.squareToCoords(a),h=this.squareToCoords(l),g=this.board[h.row][h.col],m=e[h.row][h.col],w=this.generateMoveNotation(u.row,u.col,h.row,h.col,g,m,this.gameStatus==="check",this.gameStatus==="checkmate"),E=this.generateMoveCommentary(u.row,u.col,h.row,h.col,g,m,null);return this.recordGameState({from:u,to:h,piece:g,captured:m,notation:w,commentary:E}),m?this.playSound("capture"):this.playSound("move"),this.gameStatus==="checkmate"?setTimeout(()=>this.playSound("checkmate"),m?100:0):this.gameStatus==="check"&&setTimeout(()=>this.playSound("check"),m?100:0),await this.autoSave(),{from:u,to:h,piece:g,enteredCheck:n}}}catch{}return null}async executeBotMove(){const e=this.gameMode==="human-vs-bot",i=this.isBotTurn(),n=this.gameStatus==="playing"||this.gameStatus==="check";if(!e||!i||!n)return{success:!1,enteredCheck:!1};const o=Date.now(),a=await this.generateBotMove();if(!a)return{success:!1,enteredCheck:!1};const l=a.enteredCheck||!1,u=Date.now()-o,h=800+Math.random()*400,g=Math.max(0,h-u);return await new Promise(m=>setTimeout(m,g)),await this.autoSave(),{success:!0,enteredCheck:l}}recordGameState(e){this.currentStateIndex<this.stateHistory.length-1&&(this.stateHistory=this.stateHistory.slice(0,this.currentStateIndex+1)),this.isInUndoRedoState=!1;const i=100,n={engineState:null,move:{from:e.from,to:e.to,piece:e.piece,captured:e.captured},notation:e.notation,commentary:e.commentary,timestamp:Date.now()};this.stateHistory.push(n),this.currentStateIndex++,this.stateHistory.length>i&&(this.stateHistory.length-i,this.stateHistory=[this.stateHistory[0],...this.stateHistory.slice(-99)],this.currentStateIndex=this.stateHistory.length-1),this.moveHistory||(this.moveHistory=[]),this.moveHistory.push({from:e.from,to:e.to,piece:e.piece,captured:e.captured,notation:e.notation}),this.moveHistory.length>i-1&&(this.moveHistory=this.moveHistory.slice(-99)),this.autoSave().catch(o=>{})}coordsToSquare(e,i){const n=["A","B","C","D","E","F","G","H"],o=["8","7","6","5","4","3","2","1"];return n[i]+o[e]}squareToCoords(e){const i=["A","B","C","D","E","F","G","H"],n=["8","7","6","5","4","3","2","1"],o=e[0],a=e[1],l=i.indexOf(o);return{row:n.indexOf(a),col:l}}engineStateToBoard(){const e=this.engine.exportJson(),i=Array(8).fill(null).map(()=>Array(8).fill(null));for(const[n,o]of Object.entries(e.pieces)){const a=this.squareToCoords(n),l=this.parsePiece(o);l!==null&&(i[a.row][a.col]=l)}return i}parsePiece(e){if(typeof e!="string"||e.length!==1)return null;const i=e===e.toUpperCase(),o={K:"king",Q:"queen",R:"rook",B:"bishop",N:"knight",P:"pawn"}[e.toUpperCase()];return o?{type:o,color:i?"white":"black"}:null}newGame(){this.engine=new window.jsChessEngine.Game,this.selectedSquare=null,this.possibleMoves=[],this.moveHistory=[],this.currentMoveIndex=-1,this.initialEngineState=JSON.parse(JSON.stringify(this.engine.exportJson())),this.colorChangedMidGame=!1,this.originalHumanColor=this.humanColor,this.stateHistory=[],this.currentStateIndex=0,this.isInUndoRedoState=!1;const e=this.engine.exportJson();this.stateHistory.push({engineState:JSON.parse(JSON.stringify(e)),move:null,captured:null,notation:null,commentary:null}),this.updateCachedState(),this.updateGameStatus(),this.boardFlipped=this.determineOrientation(),this.playSound("newGame")}setGameMode(e){this.gameMode=e}setHumanColor(e){this.gameMode==="human-vs-bot"&&this.moveHistory&&this.moveHistory.length>0&&(this.colorChangedMidGame=e!==this.originalHumanColor),this.humanColor=e,this.boardFlipped=this.determineOrientation()}setBotDifficulty(e){this.gameMode==="human-vs-bot"&&this.moveHistory&&this.moveHistory.length>0&&(this.difficultyChangedMidGame=e!==this.originalBotDifficulty),this.botDifficulty=e}setBotDifficulty(e){this.gameMode==="human-vs-bot"&&this.moveHistory&&this.moveHistory.length>0&&(this.difficultyChangedMidGame=e!==this.originalBotDifficulty),this.botDifficulty=e}getGameMode(){return this.gameMode}getHumanColor(){return this.humanColor}shouldFlipBoard(){return this.gameMode==="human-vs-bot"&&this.humanColor==="black"}determineOrientation(){this.boardFlipped;let e=!1;return this.gameMode==="human-vs-human"?this.orientationMode==="none"?e=!1:this.orientationMode==="table"?e=this.currentPlayer==="black":this.orientationMode==="handoff"&&(e=this.currentPlayer==="black"):e=this.humanColor==="black",e}setCorrectBoardPerspective(){const e=this.shouldFlipBoard();return this.boardFlipped!==e?(this.boardFlipped=e,!0):!1}getGameState(){const e=this.engine.exportJson();return{board:this.board,currentPlayer:this.currentPlayer,gameStatus:this.gameStatus,moveHistory:this.moveHistory,stateHistory:this.stateHistory,currentStateIndex:this.currentStateIndex,selectedSquare:this.selectedSquare,possibleMoves:this.possibleMoves,gameMode:this.gameMode,humanColor:this.humanColor,botDifficulty:this.botDifficulty,allowUndo:this.allowUndo,boardFlipped:this.boardFlipped,orientationMode:this.orientationMode,castlingRights:this.castlingRights,enPassantTarget:this.enPassantTarget,soundEnabled:this.soundEnabled,engineState:e}}loadGameState(e,i={}){var o,a,l,u,h,g,m,w;if(e.engineState)this.engine=new window.jsChessEngine.Game(e.engineState);else{const E={pieces:{},turn:e.currentPlayer,castling:{whiteShort:((a=(o=e.castlingRights)==null?void 0:o.white)==null?void 0:a.kingside)||!1,whiteLong:((u=(l=e.castlingRights)==null?void 0:l.white)==null?void 0:u.queenside)||!1,blackShort:((g=(h=e.castlingRights)==null?void 0:h.black)==null?void 0:g.kingside)||!1,blackLong:((w=(m=e.castlingRights)==null?void 0:m.black)==null?void 0:w.queenside)||!1},enPassant:e.enPassantTarget||null},C=["A","B","C","D","E","F","G","H"],k=["8","7","6","5","4","3","2","1"];for(let S=0;S<8;S++)for(let M=0;M<8;M++){const G=e.board[S][M];if(G){const I=C[M]+k[S],q={pawn:"P",rook:"R",knight:"N",bishop:"B",queen:"Q",king:"K"}[G.type];E.pieces[I]=G.color==="white"?q:q.toLowerCase()}}this.engine=new window.jsChessEngine.Game(E)}if(this.selectedSquare=e.selectedSquare||null,this.possibleMoves=e.possibleMoves||[],i.preserveGameMode||(this.gameMode=e.gameMode||"human-vs-bot"),this.humanColor=e.humanColor||"white",this.botDifficulty=e.botDifficulty!==void 0?e.botDifficulty:1,this.allowUndo=e.allowUndo!==void 0?e.allowUndo:!0,this.orientationMode=e.orientationMode||"handoff",this.boardFlipped=!1,this.soundEnabled=e.soundEnabled!==void 0?e.soundEnabled:!0,this.moveHistory=e.moveHistory||[],this.moveHistory.length>100-1&&(this.moveHistory=this.moveHistory.slice(-99)),this.currentMoveIndex=e.currentMoveIndex!==void 0?e.currentMoveIndex:this.moveHistory.length-1,e.initialEngineState)this.initialEngineState=JSON.parse(JSON.stringify(e.initialEngineState));else{const E=new window.jsChessEngine.Game;this.initialEngineState=JSON.parse(JSON.stringify(E.exportJson()))}if(!this.initialEngineState.pieces||!this.initialEngineState.pieces.E2){const E=new window.jsChessEngine.Game;this.initialEngineState=JSON.parse(JSON.stringify(E.exportJson()))}if(this.updateCachedState(),this.boardFlipped=this.determineOrientation(),e.stateHistory&&e.stateHistory.length>0){this.stateHistory=e.stateHistory,this.currentStateIndex=e.currentStateIndex||e.stateHistory.length-1;const E=100;this.stateHistory.length>E&&(this.stateHistory.length-E,this.stateHistory=[this.stateHistory[0],...this.stateHistory.slice(-99)],this.currentStateIndex===e.stateHistory.length-1?this.currentStateIndex=this.stateHistory.length-1:this.currentStateIndex=Math.min(this.currentStateIndex,this.stateHistory.length-1))}else{this.stateHistory=[],this.currentStateIndex=0;const E=new window.jsChessEngine.Game;if(this.stateHistory.push({engineState:JSON.parse(JSON.stringify(E.exportJson())),move:null,notation:null,timestamp:Date.now()}),e.moveHistory&&e.moveHistory.length>0){const C=new window.jsChessEngine.Game;for(let k=0;k<e.moveHistory.length;k++){const S=e.moveHistory[k],M=this.coordsToSquare(S.from.row,S.from.col),G=this.coordsToSquare(S.to.row,S.to.col);try{C.move(M,G),this.stateHistory.push({engineState:JSON.parse(JSON.stringify(C.exportJson())),move:S,notation:S.notation||`${M}-${G}`,timestamp:Date.now()}),this.currentStateIndex++}catch{break}}}}}async autoSave(){try{const e=this.getGameState(),i=this.getStorageKey();return await te(i,e),await te("last_game_mode",{mode:this.gameMode,timestamp:Date.now()}),!0}catch{return!1}}getStorageKey(){return`chess_game_state_${this.gameMode.replace(/-/g,"_")}`}isHumanTurn(){return this.gameMode==="human-vs-human"?!0:this.currentPlayer===this.humanColor}getGameModeDisplayText(){return this.gameMode==="human-vs-human"?"Human vs Human":`Human (${this.humanColor}) vs Bot`}getBotDifficultyText(){return{0:"Random",1:"Ella",2:"Evy",3:"Emmy",4:"Asa"}[this.botDifficulty]||"Ella"}getColorOptions(){return[{value:"white",label:"White"},{value:"black",label:"Black"}]}getGameModeOptions(){return[{value:"human-vs-bot",label:"Human vs Bot"},{value:"human-vs-human",label:"Human vs Human"}]}createSoundSystem(){const e={},i=window.woodenSoundData||{},n={moves:[i.move_1,i.move_2,i.move_3,i.move_4,i.move_5],quick:[i.quick_1,i.quick_2],pop_check:i.pop_check};let o=-1;const a=(l,u=.4)=>{if(!this.soundEnabled||!l)return Promise.resolve();const h=new Audio(l);return h.volume=u,h.play().catch(()=>{})};return e.move=()=>{const l=n.moves.map((h,g)=>g).filter(h=>h!==o),u=Math.floor(Math.random()*l.length);o=l[u],a(n.moves[o])},e.capture=()=>{const l=[...n.moves,...n.quick],u=Math.floor(Math.random()*l.length),h=l[u],g=l.filter((E,C)=>C!==u),m=Math.floor(Math.random()*g.length),w=g[m];a(h,.25),setTimeout(()=>a(w,.4),50)},e.check=()=>{a(n.pop_check)},e.checkmate=()=>{a(n.pop_check)},e.newGame=()=>{const l=Math.floor(Math.random()*n.moves.length);a(n.moves[l])},e.victory=()=>{a(n.pop_check)},e.gameEnd=()=>{const l=Math.floor(Math.random()*n.moves.length);a(n.moves[l])},e}playSound(e){this.sounds&&this.sounds[e]&&this.sounds[e]()}initializeBoard(){}isValidPosition(e,i){return e>=0&&e<8&&i>=0&&i<8}canUndo(){return this.allowUndo&&this.currentStateIndex>0}canRedo(){return this.allowUndo&&this.currentStateIndex<this.stateHistory.length-1}reconstructEngineState(e){if(e===0)return this.stateHistory[0].engineState;const i=this.stateHistory[0].engineState;if(!i)return null;const n=new window.jsChessEngine.Game(JSON.parse(JSON.stringify(i)));for(let o=1;o<=e;o++){const a=this.stateHistory[o].move;if(!a)break;const l=this.coordsToSquare(a.from.row,a.from.col),u=this.coordsToSquare(a.to.row,a.to.col);try{n.move(l,u)}catch{break}}return n.exportJson()}undoMove(){if(!this.canUndo())return!1;const e=this.stateHistory[this.currentStateIndex],i=e&&e.captured;this.currentStateIndex--;const n=this.stateHistory[this.currentStateIndex];let o;return n.engineState?o=JSON.parse(JSON.stringify(n.engineState)):o=this.reconstructEngineState(this.currentStateIndex),o?(this.engine=new window.jsChessEngine.Game(o),this.updateCachedState(),this.updateGameStatus(),this.board=this.engineStateToBoard(),this.selectedSquare=null,this.possibleMoves=[],this.isInUndoRedoState=!0,i?this.playSound("capture"):this.playSound("move"),this.gameStatus==="checkmate"?setTimeout(()=>this.playSound("checkmate"),i?100:0):this.gameStatus==="check"&&setTimeout(()=>this.playSound("check"),i?100:0),!0):!1}redoMove(){if(!this.canRedo())return!1;this.currentStateIndex++;const e=this.stateHistory[this.currentStateIndex];let i;if(e.engineState?i=JSON.parse(JSON.stringify(e.engineState)):i=this.reconstructEngineState(this.currentStateIndex),!i)return!1;this.engine=new window.jsChessEngine.Game(i),this.updateCachedState(),this.updateGameStatus(),this.board=this.engineStateToBoard(),e.move,this.selectedSquare=null,this.possibleMoves=[],this.isInUndoRedoState=!0;const n=e.move&&e.move.captured;return n?this.playSound("capture"):this.playSound("move"),this.gameStatus==="checkmate"?setTimeout(()=>this.playSound("checkmate"),n?100:0):this.gameStatus==="check"&&setTimeout(()=>this.playSound("check"),n?100:0),!0}getCurrentMoveIndex(){return this.currentStateIndex-1}getCapturedPieces(){const e=[],i=[];for(let o=1;o<=this.currentStateIndex&&o<this.stateHistory.length;o++){const a=this.stateHistory[o];a.move&&a.move.captured&&(a.move.captured.color==="white"?e.push(a.move.captured):i.push(a.move.captured))}const n={queen:1,rook:2,bishop:3,knight:4,pawn:5};return e.sort((o,a)=>(n[o.type]||6)-(n[a.type]||6)),i.sort((o,a)=>(n[o.type]||6)-(n[a.type]||6)),{whiteCaptured:e,blackCaptured:i}}validateGameState(){return!0}coordsToChessNotation(e,i){return this.coordsToSquare(e,i)}generateMoveNotation(e,i,n,o,a,l,u,h){const g=this.coordsToSquare(e,i),m=this.coordsToSquare(n,o);return`${g}-${m}`}generateMoveCommentary(e,i,n,o,a,l,u){this.coordsToSquare(e,i);const h=this.coordsToSquare(n,o),g=a.color.charAt(0).toUpperCase()+a.color.slice(1);return l?`${g} ${a.type} captures ${h} ${l.type}`:`${g} ${a.type} to ${h}`}calculateMaterialBalance(){const e={pawn:1,knight:3,bishop:3,rook:5,queen:9,king:0};let i=0,n=0;for(let o=0;o<8;o++)for(let a=0;a<8;a++){const l=this.board[o][a];if(l){const u=e[l.type]||0;l.color==="white"?i+=u:n+=u}}return i-n}countPieces(){let e=0;for(let i=0;i<8;i++)for(let n=0;n<8;n++)this.board[i][n]&&e++;return e}calculateBoardChecksum(e){return JSON.stringify(e).length}calculateMoveHistoryChecksum(e){return e.length}testSaveLoadCycle(){return Promise.resolve(!0)}getPieceSymbol(e){var n;return e&&((n={king:{white:"♚",black:"♚"},queen:{white:"♛",black:"♛"},rook:{white:"♜",black:"♜"},bishop:{white:"♝",black:"♝"},knight:{white:"♞",black:"♞"},pawn:{white:"♟︎",black:"♟︎"}}[e.type])==null?void 0:n[e.color])||""}isInCheck(){const e=this.engine.exportJson();return e.check||e.checkMate}}let P,B;class Te{constructor(e){this.game=e,this.boardElement=document.getElementById("chess-board"),this.moveDisplayElement=document.getElementById("move-display"),this.gameStatusElement=document.getElementById("game-status"),this.isFlipping=!1,this.inputEnabled=!0,this.lastAlertTime=0,this.alertCooldown=1e3;const i=document.getElementById("move-expand");i&&i.addEventListener("click",()=>{const n=i.dataset.fullText;n&&this.showNotification(n,"info",3e3)}),this.initializeBoard(),this.updateDisplay(),this.checkInitialBotTurn()}initializeBoard(){this.boardElement.innerHTML="";for(let e=0;e<8;e++)for(let i=0;i<8;i++){const n=document.createElement("div");n.className="chess-square",n.dataset.row=e,n.dataset.col=i;const o=(e+i)%2===0;n.classList.add(o?"light-square":"dark-square"),n.addEventListener("click",async a=>await this.handleSquareClick(a)),n.addEventListener("touchstart",a=>this.handleTouchStart(a)),n.addEventListener("touchend",async a=>await this.handleTouchEnd(a)),n.addEventListener("touchcancel",a=>this.handleTouchCancel(a)),this.boardElement.appendChild(n)}this.applyTheme()}async handleSquareClick(e){const i=parseInt(e.target.dataset.row),n=parseInt(e.target.dataset.col);await this.handleSquareSelection(i,n)}handleTouchStart(e){e.preventDefault(),this.touchStartTime=Date.now(),this.touchTarget=e.target,e.target.style.opacity="0.7"}async handleTouchEnd(e){if(e.preventDefault(),this.touchTarget&&(this.touchTarget.style.opacity=""),this.touchStartTime&&Date.now()-this.touchStartTime<500){let i=e.target;for(;i&&!i.dataset.row;)i=i.parentElement;if(i&&i.dataset.row!==void 0){const n=parseInt(i.dataset.row),o=parseInt(i.dataset.col);await this.handleSquareSelection(n,o)}}this.touchStartTime=null,this.touchTarget=null}handleTouchCancel(e){e.preventDefault(),this.touchTarget&&(this.touchTarget.style.opacity=""),this.touchStartTime=null,this.touchTarget=null}getLogicalCoordinates(e,i){const n=this.game.gameMode==="human-vs-bot",o=this.game.orientationMode==="table";return this.game.boardFlipped&&(n||o)?{row:7-e,col:7-i}:{row:e,col:i}}getDisplayCoordinates(e,i){const n=this.game.gameMode==="human-vs-bot",o=this.game.orientationMode==="table";return this.game.boardFlipped&&(n||o)?{row:7-e,col:7-i}:{row:e,col:i}}flipBoard(e){this.isFlipping||(this.isFlipping=!0,this.boardElement.style.transform="rotateY(90deg)",this.boardElement.style.transition="transform 0.3s ease-in-out",setTimeout(()=>{const i=this.game.determineOrientation();this.game.boardFlipped=i,this.updateDisplay(),this.boardElement.style.transform="rotateY(0deg)",setTimeout(()=>{this.boardElement.style.transition="",this.isFlipping=!1,e&&e()},150)},150))}updateBoardPerspective(){if(this.isFlipping)return;const e=this.game.boardFlipped,i=this.boardElement.classList.contains("flipped");e&&!i?this.boardElement.classList.add("flipped"):!e&&i&&this.boardElement.classList.remove("flipped"),this.updateDisplay()}async handleBotTurn(){if(this.game.isPerformingRedo)return;const e=this.game.gameMode,i=this.game.isBotTurn(),n=this.game.gameStatus;if(this.game.currentPlayer,this.game.getHumanColor(),e!=="human-vs-bot"||!i)return;if(n!=="playing"&&n!=="check"){this.showBotThinking(!1),this.setInputEnabled(!1);return}const o=(!this.game.moveHistory||this.game.moveHistory.length===0)&&i;this.setInputEnabled(!1),this.showBotThinking(!0),this.updateGameStateIndicators();try{o&&await new Promise(l=>setTimeout(l,500));const a=await this.game.executeBotMove();a&&a.success?(this.updateDisplay(),a.enteredCheck&&this.highlightKing(this.game.humanColor),this.showBotThinking(!1),this.game.gameStatus==="checkmate"||this.game.gameStatus==="stalemate"?(this.setInputEnabled(!1),this.handleGameEnd()):this.setInputEnabled(!0)):(this.showBotThinking(!1),this.showNotification("Bot move failed - your turn","error"),this.setInputEnabled(!0),setTimeout(()=>{this.hideInstructionLabel()},3e3))}catch{this.showBotThinking(!1),this.setInputEnabled(!0),this.showNotification("Bot error - your turn","error"),setTimeout(()=>{this.hideInstructionLabel()},3e3)}}setInputEnabled(e){this.inputEnabled=e,e?(this.boardElement.style.opacity="1",this.boardElement.style.pointerEvents="auto"):(this.boardElement.style.opacity="0.7",this.boardElement.style.pointerEvents="none")}showBotThinking(e){const i=this.game.gameMode,n=this.game.isBotTurn(),o=this.game.gameStatus;document.getElementById("instruction-label");const a=document.getElementById("move-display");if(e&&i==="human-vs-bot"&&n&&(o==="playing"||o==="check")){if(this.hideInstructionLabel(),a&&!document.querySelector(".bot-thinking-spinner")){const l=document.createElement("div");l.className="bot-thinking-spinner",a.parentElement.appendChild(l)}this.inputEnabled&&this.setInputEnabled(!1),this.updatePlayerTurnIndicator(this.game.currentPlayer,i)}else{this.hideInstructionLabel();const l=document.querySelector(".bot-thinking-spinner");l&&l.remove(),i==="human-vs-bot"&&this.updatePlayerTurnIndicator(this.game.currentPlayer,i)}}hideInstructionLabel(){const e=document.getElementById("instruction-label");e&&(e.classList.add("hidden"),e.textContent="")}handleGameEnd(){const e=this.game.gameStatus,i=this.game.currentPlayer;this.setInputEnabled(!1);let n=!1;if(e==="checkmate"){const o=i==="white"?"Black":"White";this.game.gameMode==="human-vs-bot"?(this.game.humanColor==="white"&&o==="White"||this.game.humanColor==="black"&&o==="Black")&&(n=!0):n=!0}this.game.soundEnabled&&this.game.sounds&&(n?this.game.sounds.victory():this.game.sounds.gameEnd())}updateGameStateIndicators(){this.game.gameStatus;const e=this.game.currentPlayer,i=this.game.gameMode;this.updatePlayerTurnIndicator(e,i),this.updateCapturedPiecesDisplay(),this.updateMoveHistoryDisplay()}updatePlayerTurnIndicator(e,i){const n=document.getElementById("current-player");if(!n)return;let o="";try{const u=this.game.calculateMaterialBalance();e==="white"?u>0?o=` (+${u})`:u<0&&(o=` (${u})`):u<0?o=` (+${Math.abs(u)})`:u>0&&(o=` (-${u})`)}catch{}let a="",l=`player-indicator ${e}`;if(i==="human-vs-bot"){this.game.getHumanColor();const u=this.game.isBotTurn(),h=this.game.gameStatus;if(h==="checkmate"||h==="stalemate")a=`Game Over (${h})`,l+=" game-ended";else if(h==="check")u?(a="Bot's turn",l+=" bot-turn check"):(a="Your turn",l+=" human-turn check");else if(u){const g=document.getElementById("instruction-label");g&&!g.classList.contains("hidden")&&g.textContent.includes("Bot is thinking")?(a="Bot is thinking...",l+=" bot-thinking"):(a="Bot's turn",l+=" bot-turn")}else a="Your turn",l+=" human-turn"}else a=`${e.charAt(0).toUpperCase()+e.slice(1)}'s turn`;n.textContent=a,n.className=l}updateCapturedPiecesDisplay(){const e=document.getElementById("captured-pieces");if(!e)return;const{whiteCaptured:i,blackCaptured:n}=this.game.getCapturedPieces(),o=this.game.gameMode,a=this.game.getHumanColor();e.innerHTML="";const l=this.game.calculateMaterialBalance(),u=this.createMaterialBalanceBar(l,o,a);e.appendChild(u);const h=document.createElement("div");h.className="captured-section left";const g=document.createElement("div");if(g.className="captured-section right",o==="human-vs-bot"){const w=a==="white",E=w?n:i,C=w?i:n,k=document.createElement("span");k.className="captured-label",k.textContent="White",h.appendChild(k);const S=document.createElement("span");S.className="captured-pieces-list",S.textContent=E.length>0?E.map(I=>this.game.getPieceSymbol(I)).join(""):"-",h.appendChild(S),h.dataset.pieceCount=E.length;const M=document.createElement("span");M.className="captured-label",M.textContent="Black",g.appendChild(M);const G=document.createElement("span");G.className="captured-pieces-list",G.textContent=C.length>0?C.map(I=>this.game.getPieceSymbol(I)).join(""):"-",g.appendChild(G),g.dataset.pieceCount=C.length}else{const w=document.createElement("span");w.className="captured-label",w.textContent="White",h.appendChild(w);const E=document.createElement("span");E.className="captured-pieces-list",E.textContent=n.length>0?n.map(S=>this.game.getPieceSymbol(S)).join(""):"-",h.appendChild(E),h.dataset.pieceCount=n.length;const C=document.createElement("span");C.className="captured-label",C.textContent="Black",g.appendChild(C);const k=document.createElement("span");k.className="captured-pieces-list",k.textContent=i.length>0?i.map(S=>this.game.getPieceSymbol(S)).join(""):"-",g.appendChild(k),g.dataset.pieceCount=i.length}const m=document.createElement("div");m.className="captured-sections-wrapper",m.appendChild(h),m.appendChild(g),e.appendChild(m),e.style.display="flex"}createMaterialBalanceBar(e,i,n){const o=document.createElement("div");o.className="material-balance-bar";const a=Math.max(0,Math.min(100,(e+39)/78*100)),l=document.createElement("div");let u="balance-indicator";return i==="human-vs-bot"&&(n==="white"&&e>0||n==="black"&&e<0?u+=" human-advantage":e!==0&&(u+=" bot-advantage")),l.className=u,l.style.width=`${a}%`,o.appendChild(l),o}updateMoveHistoryDisplay(){const e=document.getElementById("move-history");if(!e||this.game.currentStateIndex<=0)return;const i=this.game.stateHistory.slice(1,this.game.currentStateIndex+1),n=i.slice(-6);let o='<div class="move-history-title">Recent Moves:</div>';n.forEach((a,l)=>{const u=i.indexOf(a)+1,h=this.game.gameMode==="human-vs-bot"&&a.move&&a.move.piece&&a.move.piece.color!==this.game.humanColor;o+=`
        <div class="move-entry ${h?"bot-move":"human-move"}">
          <span class="move-player">${h?"🤖":"👤"}</span>
          <span class="move-notation">${a.notation}</span>
          <span class="move-number">#${u}</span>
        </div>
      `}),e.innerHTML=o}checkInitialBotTurn(){if(this.game.gameMode!=="human-vs-bot")return;this.game.getHumanColor(),this.game.currentPlayer;const e=this.game.isBotTurn();if(!((this.game.moveHistory?this.game.moveHistory.length:0)>0)&&!(this.game.gameStatus==="checkmate"||this.game.gameStatus==="stalemate")){if(this.game.gameStatus!=="playing"){setTimeout(()=>{this.checkInitialBotTurn()},500);return}e?(this.showBotThinking(!0),this.setInputEnabled(!1),this.updateGameStateIndicators(),setTimeout(()=>{const n=this.game.isBotTurn(),o=!this.game.moveHistory||this.game.moveHistory.length===0;this.game.gameStatus==="playing"&&n&&o?this.handleBotTurn():o||(this.showBotThinking(!1),this.setInputEnabled(!0),this.updateGameStateIndicators())},1e3)):(this.setInputEnabled(!0),this.showBotThinking(!1),this.updateGameStateIndicators())}}onNewGameStart(){this.updateDisplay(),(!this.game.moveHistory||this.game.moveHistory.length===0)&&this.checkInitialBotTurn()}async handleSquareSelection(e,i){if(this.isFlipping||this.inputEnabled===!1)return;if(this.game.gameMode==="human-vs-bot"&&this.game.isBotTurn())if(this.game.isInUndoRedoState){const l=this.getLogicalCoordinates(e,i),u=l.row,h=l.col,g=this.game.board[u][h];if(this.game.lastUndoWasBotMove?this.showNotification("Bot turn - scroll wheel to redo or make your move","warning"):this.showNotification("Bot turn - scroll wheel to redo or make your move","warning"),!(g&&g.color===this.game.humanColor))return}else{const l=document.getElementById("instruction-label");(!l||l.classList.contains("hidden")||!l.textContent.includes("Bot is thinking"))&&this.showNotification("Bot turn","info");return}const n=this.getLogicalCoordinates(e,i),o=n.row,a=n.col;if(this.game.selectedSquare){const l=this.game.selectedSquare.row,u=this.game.selectedSquare.col;if(l===o&&u===a)this.game.selectedSquare=null;else if(this.game.getPossibleMoves(l,u).find(m=>m.row===o&&m.col===a)){this.game.gameStatus;const m=await this.game.makeMove(l,u,o,a);if(m&&m.success){if(this.game.isInUndoRedoState=!1,this.game.lastUndoWasBotMove=!1,this.game.selectedSquare=null,m.enteredCheck&&this.highlightKing(this.game.currentPlayer),!(this.game.gameMode==="human-vs-human"&&!this.game.isUndoRedoAction)){if(this.game.gameMode==="human-vs-bot"&&!this.game.isUndoRedoAction){const w=this.game.gameStatus==="playing"||this.game.gameStatus==="check",E=this.game.isBotTurn();w&&E?(this.showBotThinking(!0),this.setInputEnabled(!1),this.updateGameStateIndicators(),setTimeout(()=>{this.handleBotTurn()},150)):this.game.gameStatus==="checkmate"||this.game.gameStatus==="stalemate"?this.setInputEnabled(!1):this.setInputEnabled(!0)}}}else this.game.selectedSquare=null}else{const m=this.game.board[o][a];if(m&&m.color===this.game.currentPlayer){this.game.selectedSquare={row:o,col:a},this.updateDisplay();return}this.game.isInCheck()?this.highlightKing(this.game.currentPlayer):this.game.selectedSquare=null}}else{const l=this.game.board[o][a];l&&l.color===this.game.currentPlayer&&(this.game.selectedSquare={row:o,col:a})}this.updateDisplay()}updateDisplay(){const e=document.getElementById("game-container");e.classList.remove("orientation-table","orientation-handoff","orientation-none");const i=this.game.gameMode==="human-vs-bot"?"none":this.game.orientationMode;e.setAttribute("data-orientation-mode",i),e.setAttribute("data-board-flipped",this.game.boardFlipped.toString()),e.setAttribute("data-game-mode",this.game.gameMode),e.setAttribute("data-current-player",this.game.currentPlayer);const n=this.boardElement.children;for(let u=0;u<n.length;u++){const h=n[u],g=parseInt(h.dataset.row),m=parseInt(h.dataset.col),w=this.getLogicalCoordinates(g,m),E=this.game.board[w.row][w.col];if(h.innerHTML="",h.classList.remove("selected","valid-move","white-move","black-move","last-move"),E){const C=document.createElement("div");C.className=`chess-piece ${E.color}`,C.setAttribute("data-piece",E.type),C.textContent=this.game.getPieceSymbol(E),h.appendChild(C),w.row===1&&w.col===4||w.row===3&&w.col}if(this.game.selectedSquare&&this.game.selectedSquare.row===w.row&&this.game.selectedSquare.col===w.col&&h.classList.add("selected"),this.game.selectedSquare&&this.game.getPossibleMoves(this.game.selectedSquare.row,this.game.selectedSquare.col).some(k=>k.row===w.row&&k.col===w.col)&&(h.classList.add("valid-move"),h.classList.add(this.game.currentPlayer==="white"?"white-move":"black-move")),this.game.currentStateIndex>0&&this.game.currentStateIndex<this.game.stateHistory.length){const C=this.game.stateHistory[this.game.currentStateIndex];if(C&&C.move){const k=C.move;(k.from.row===w.row&&k.from.col===w.col||k.to.row===w.row&&k.to.col===w.col)&&h.classList.add("last-move")}}}this.game.calculateMaterialBalance(),this.game.currentPlayer;const o=document.getElementById("move-display"),a=document.getElementById("move-expand"),l=document.getElementById("move-info");if(o){let u="";if(this.game.currentStateIndex>0&&this.game.currentStateIndex<this.game.stateHistory.length){const h=this.game.stateHistory[this.game.currentStateIndex];if(h&&h.move){const g=h.commentary||h.notation;let m="";this.game.gameStatus==="checkmate"?m='<span style="color: #FE5F00;"> - Checkmate!</span>':this.game.gameStatus==="check"?m='<span style="color: #FE5F00;"> - Check!</span>':this.game.gameStatus==="stalemate"&&(m='<span style="color: #FE5F00;"> - Stalemate!</span>'),u=g+m}}u||(this.game.gameMode==="human-vs-human"?u="Human vs Human • Ready to play":u=`Bot (${this.game.getBotDifficultyText()}) • Ready to play`),u.includes("<span")?o.innerHTML=u:o.textContent=u,setTimeout(()=>{o.scrollWidth>o.clientWidth&&a&&l?(l.classList.add("has-overflow"),a.dataset.fullText=o.textContent):l&&l.classList.remove("has-overflow")},0)}this.gameStatusElement.textContent="",this.updateGameStateIndicators(),this.game.gameStatus!=="playing"&&this.game.gameStatus!=="check"&&setTimeout(()=>{this.handleGameEnd()},300)}applyTheme(){const e={light:"#ddb88c",dark:"#a0522d",lightTexture:"radial-gradient(circle at 25% 25%, #c9a876 0%, transparent 50%), radial-gradient(circle at 75% 75%, #c9a876 0%, transparent 50%)",darkTexture:"radial-gradient(circle at 25% 25%, #8b4513 0%, transparent 50%), radial-gradient(circle at 75% 75%, #8b4513 0%, transparent 50%)"};document.documentElement.style.setProperty("--light-square",e.light),document.documentElement.style.setProperty("--dark-square",e.dark);const i=this.boardElement.children;for(let n=0;n<i.length;n++){const o=i[n],a=parseInt(o.dataset.row),l=parseInt(o.dataset.col);(a+l)%2===0?(o.style.backgroundColor=e.light,o.style.backgroundImage=e.lightTexture):(o.style.backgroundColor=e.dark,o.style.backgroundImage=e.darkTexture)}}showMessage(e){this.gameStatusElement.textContent=e,setTimeout(()=>{this.updateDisplay()},2e3)}showOptionsMenu(){const e=document.getElementById("options-overlay");if(e){e.classList.remove("hidden"),this.game.originalGameMode=this.game.gameMode,this.game.originalHumanColor=this.game.humanColor,this.game.colorChangedMidGame=!1,this.game.originalBotDifficulty=this.game.botDifficulty,this.game.difficultyChangedMidGame=!1;const i=document.getElementById("options-menu");i&&(i.scrollTop=0),this.updateOptionsButtons(),e.dataset.listenersAdded||(this.setupOptionsEventListeners(),e.dataset.listenersAdded="true")}}hideOptionsMenu(){const e=document.getElementById("options-overlay");e&&e.classList.add("hidden");const i=this.game.determineOrientation();this.game.boardFlipped!==i&&(this.game.boardFlipped=i,this.updateDisplay()),this.game.gameMode==="human-vs-bot"&&this.game.moveHistory.length===0&&setTimeout(()=>{this.checkInitialBotTurn()},100)}updateOptionsButtons(){const e=document.getElementById("options-title");if(e){const C=this.game.gameMode==="human-vs-human"?"Human vs Human":"Human vs Bot";e.textContent=`Chess R1 - ${C}`}const i=document.getElementById("back-btn");if(i){const C=this.game.moveHistory&&this.game.moveHistory.length>0,k=this.game.stateHistory&&this.game.stateHistory.length>1,S=C||k,M=this.game.gameMode!==this.game.originalGameMode,G=this.game.colorChangedMidGame,I=this.game.difficultyChangedMidGame;S?(G||I)&&!M?(i.disabled=!0,G&&I?i.textContent="Start new game (settings changed)":G?i.textContent="Start new game (color changed)":i.textContent="Start new game (difficulty changed)",i.classList.add("disabled")):(i.disabled=!1,i.textContent="Back to game",i.classList.remove("disabled")):(i.disabled=!0,i.textContent="Back to game (no moves yet)",i.classList.add("disabled"))}document.querySelectorAll('input[name="gameMode"]').forEach(C=>{C.checked=C.value===this.game.gameMode}),document.querySelectorAll('input[name="playerColor"]').forEach(C=>{C.checked=C.value===this.game.humanColor}),document.querySelectorAll('input[name="soundEffects"]').forEach(C=>{C.checked=C.value==="on"===this.game.soundEnabled}),document.querySelectorAll('input[name="allowUndo"]').forEach(C=>{C.checked=C.value==="on"===this.game.allowUndo}),document.querySelectorAll('input[name="botDifficulty"]').forEach(C=>{C.checked=C.value===String(this.game.botDifficulty)});const h=document.getElementById("color-group");h&&(this.game.gameMode==="human-vs-bot"?(h.style.display="block",h.offsetHeight):h.style.display="none");const g=document.getElementById("difficulty-group");g&&(this.game.gameMode==="human-vs-bot"?(g.style.display="block",g.offsetHeight):g.style.display="none");const m=document.getElementById("orientation-mode-group");m&&(this.game.gameMode==="human-vs-human"?(m.style.display="block",m.offsetHeight):m.style.display="none");const w=document.getElementById("undo-group");w&&(w.style.display="block",w.offsetHeight),document.querySelectorAll('input[name="orientationMode"]').forEach(C=>{C.checked=C.value===this.game.orientationMode})}setupOptionsEventListeners(){document.querySelectorAll('input[name="gameMode"]').forEach(m=>{m.addEventListener("change",async()=>{if(m.checked&&m.value!==this.game.gameMode)try{const w=this.game.gameMode;await this.game.autoSave(),this.game.setGameMode(m.value),te("last_game_mode",{mode:m.value,timestamp:Date.now()}),this.game.colorChangedMidGame=!1,this.game.originalHumanColor=this.game.humanColor,this.game.difficultyChangedMidGame=!1,this.game.originalBotDifficulty=this.game.botDifficulty;const E=this.game.getStorageKey(),C=localStorage.getItem(E);if(C)try{const M=JSON.parse(C)}catch{}const k=await W(E);let S=!1;try{S=k&&this.isValidSavedState(k)}catch{S=!1}S?(this.game.loadGameState(k,{preserveGameMode:!0}),this.updateDisplay(),this.showMessage(`Switched to ${m.value==="human-vs-human"?"Human vs Human":"Human vs Bot"} - Game restored!`)):(this.game.newGame(),this.onNewGameStart(),this.showMessage(`Switched to ${m.value==="human-vs-human"?"Human vs Human":"Human vs Bot"} - New game started!`))}catch{this.game.newGame(),this.onNewGameStart()}finally{this.updateOptionsButtons(),setTimeout(()=>{this.updateOptionsButtons(),document.getElementById("color-group"),document.getElementById("difficulty-group"),document.getElementById("orientation-mode-group"),document.getElementById("undo-group")},10)}})}),document.querySelectorAll('input[name="playerColor"]').forEach(m=>{m.addEventListener("change",()=>{m.checked&&(this.game.setHumanColor(m.value),this.game.autoSave(),this.updateOptionsButtons())})}),document.querySelectorAll('input[name="soundEffects"]').forEach(m=>{m.addEventListener("change",()=>{if(m.checked){const w=m.value==="on";this.game.soundEnabled=w,this.game.autoSave()}})}),document.querySelectorAll('input[name="allowUndo"]').forEach(m=>{m.addEventListener("change",()=>{if(m.checked){const w=m.value==="on";this.game.allowUndo=w,this.game.autoSave()}})}),document.querySelectorAll('input[name="botDifficulty"]').forEach(m=>{m.addEventListener("change",()=>{if(m.checked){const w=parseInt(m.value);this.game.setBotDifficulty(w),this.game.autoSave(),this.updateOptionsButtons()}})});const l=document.getElementById("new-game-btn"),u=document.getElementById("back-btn"),h=document.getElementById("options-overlay");l&&l.addEventListener("click",()=>{this.confirmNewGame()}),u&&u.addEventListener("click",()=>{this.hideOptionsMenu()}),document.querySelectorAll('input[name="orientationMode"]').forEach(m=>{m.addEventListener("change",()=>{if(m.checked){this.game.orientationMode=m.value;const w={table:"Table mode: Entire screen rotates for players sitting across",handoff:"Handoff mode: Pass device between players",none:"No rotation: Board stays fixed"};this.showMessage(w[m.value]),this.game.autoSave()}})}),h&&h.addEventListener("click",m=>{m.target===h&&this.hideOptionsMenu()})}confirmNewGame(){this.clearSavedState(),this.game.newGame(),this.updateDisplay(),this.hideOptionsMenu(),this.game.gameMode==="human-vs-bot"&&this.game.humanColor==="black"&&setTimeout(()=>{this.game.gameStatus==="playing"&&this.game.isBotTurn()&&this.checkInitialBotTurn()},1500),this.showMessage("New game started!")}async clearSavedState(){const i=[this.game.getStorageKey(),"chess_game_state"];if(window.creationStorage)try{for(const n of i)await window.creationStorage.plain.removeItem(n)}catch{}else try{for(const n of i)localStorage.removeItem(n)}catch{}}showNotification(e,i="default",n=null){const o=document.getElementById("instruction-label");if(!o)return;n===null&&(n=i==="warning"||i==="error"?3e3:2e3);const a=e.includes("Bot move undone")||e.includes("Bot turn");(i==="warning"||i==="error")&&this.notificationCooldown&&!a||(this.notificationTimeout&&clearTimeout(this.notificationTimeout),o.textContent=e,o.classList.remove("hidden"),o.style.backgroundColor="#FE5F00",o.style.color="white",o.style.fontWeight="bold",(i==="warning"||i==="error")&&(this.notificationCooldown=!0),this.notificationTimeout=setTimeout(()=>{o.classList.add("hidden"),o.style.backgroundColor="",o.style.color="",o.style.fontWeight="",(i==="warning"||i==="error")&&setTimeout(()=>{this.notificationCooldown=!1},500)},n))}showInstructionLabel(e){this.showNotification(e,"default",2e3)}showBotUndoAlert(e){this.showNotification(e,"warning",3e3)}showCheckAlert(e){this.showNotification(e,"warning",3e3)}highlightKing(e){for(let i=0;i<8;i++)for(let n=0;n<8;n++){const o=this.game.board[i][n];if(o&&o.type==="king"&&o.color===e){const a=this.boardElement.children[i*8+n];a&&(a.classList.contains("king-warning")||(a.classList.add("king-warning"),setTimeout(()=>{a.classList.remove("king-warning")},2e3)));return}}}animateUndoRedo(e,i=!1){const n=this.boardElement;if(n){const h=window.getComputedStyle(n).transform,g=h&&h!=="none",m=e==="undo"?.98:1.02;g?n.style.transform=`${h} scale(${m})`:n.style.transform=`scale(${m})`,n.style.transition="transform 0.1s ease",setTimeout(()=>{g?n.style.transform=h:n.style.transform="scale(1)",setTimeout(()=>{n.style.transform="",n.style.transition=""},100)},100)}const o=this.game.getCurrentMoveIndex(),a=this.game.moveHistory?this.game.moveHistory.length:0,l=Math.ceil((o+1)/2);e==="undo"&&i&&(this.game.lastUndoWasBotMove=!0),e==="undo"?o>=0?this.showInstructionLabel(`At move ${l} (${o+1}/${a})`):this.showInstructionLabel("At start of game"):e==="redo"&&this.showInstructionLabel(`At move ${l} (${o+1}/${a})`)}verifyUIConsistency(){const e=[];try{const i=document.getElementById("current-player");if(i){const u=i.textContent.toLowerCase();u.includes(this.game.currentPlayer)||e.push(`Current player display mismatch: UI shows "${u}", game state is "${this.game.currentPlayer}"`)}const n=document.getElementById("move-count");if(n){const u=this.game.getCurrentMoveIndex(),h=u>=0?Math.ceil((u+1)/2):0,g=n.textContent;g.includes(h.toString())||e.push(`Move count display mismatch: UI shows "${g}", expected move number ${h}`)}const o=this.boardElement.children;let a=0;for(let u=0;u<o.length;u++){const h=o[u],g=parseInt(h.dataset.row),m=parseInt(h.dataset.col),w=this.game.board[g][m],E=h.querySelectorAll(".chess-piece"),C=E.length>0,k=w!==null;if(C!==k)a++;else if(k&&C){const S=E[0],M=this.game.getPieceSymbol(w);S.textContent!==M&&a++}}a>0&&e.push(`Board display has ${a} piece mismatches with game state`);const l=document.getElementById("game-status");if(l&&l.textContent.trim()){const u=l.textContent.toLowerCase();this.game.gameStatus==="checkmate"&&!u.includes("checkmate")?e.push(`Game status display mismatch: game is checkmate but UI shows "${u}"`):this.game.gameStatus==="stalemate"&&!u.includes("stalemate")&&e.push(`Game status display mismatch: game is stalemate but UI shows "${u}"`)}return!(e.length>0)}catch{return!1}}updateMenuVisibility(){const e=document.getElementById("color-group"),i=document.getElementById("difficulty-group"),n=document.getElementById("orientation-mode-group");this.game.gameMode==="human-vs-human"?(e&&(e.style.display="none"),i&&(i.style.display="none"),n&&(n.style.display="block")):(e&&(e.style.display="block"),i&&(i.style.display="block"),n&&(n.style.display="none"))}getLatestTimestamp(e){if(!e)return 0;if(e.stateHistory&&e.stateHistory.length>0){const i=e.stateHistory[e.stateHistory.length-1];if(i&&i.timestamp)return i.timestamp}return e.moveHistory&&e.moveHistory.length>0?1:0}async loadGameState(){try{const e=await W("last_game_mode"),i=(e==null?void 0:e.mode)||null,n="chess_game_state_human_vs_bot",o="chess_game_state_human_vs_human",a=await W(n),l=await W(o);let u=null,h=null;if(i&&(i==="human-vs-human"&&l?(u=l,h="human-vs-human"):i==="human-vs-bot"&&a&&(u=a,h="human-vs-bot")),!u)if(a&&l){const g=this.getLatestTimestamp(a);this.getLatestTimestamp(l)>g?(u=l,h="human-vs-human"):(u=a,h="human-vs-bot")}else l?(u=l,h="human-vs-human"):a&&(u=a,h="human-vs-bot");return u||(u=await W("chess_game_state"),u&&(h=u.gameMode||"human-vs-bot")),u?this.isValidSavedState(u)?(h&&(this.game.gameMode=h),this.game.loadGameState(u),this.applyTheme(),this.updateDisplay(),this.updateMenuVisibility(),!0):(await this.clearSavedState(),!1):!1}catch{return await this.clearSavedState(),!1}}isValidSavedState(e){if(!e||typeof e!="object"||!e.board||!Array.isArray(e.board)||e.moveHistory&&!Array.isArray(e.moveHistory)||e.board.length!==8)return!1;for(let a=0;a<e.board.length;a++){const l=e.board[a];if(!Array.isArray(l)||l.length!==8)return!1}if(!e.currentPlayer||e.currentPlayer!=="white"&&e.currentPlayer!=="black")return!1;const n=(e.moveHistory||[]).length,o=e.totalMoves||n;return!!(n>0||e.currentPlayer==="black"||e.gameStatus&&(e.gameStatus==="checkmate"||e.gameStatus==="stalemate")||e.currentMoveIndex!==void 0&&e.currentMoveIndex>=0||o>0||this.boardDiffersFromInitial(e.board))}boardDiffersFromInitial(e){if(!e||!Array.isArray(e))return!1;const i=this.game?this.game.initializeBoard():this.initializeBoard();for(let n=0;n<8;n++){if(!e[n]||!Array.isArray(e[n]))return!1;for(let o=0;o<8;o++){const a=e[n][o],l=i[n][o];if(!(a===null&&l===null)&&(a===null||l===null||a.type!==l.type||a.color!==l.color))return!0}}return!1}}window.addEventListener("scrollUp",async()=>{if(P&&B)if(P.allowUndo){let b=!1;if(P.gameMode==="human-vs-bot"&&P.currentStateIndex<P.stateHistory.length-1){const e=P.stateHistory[P.currentStateIndex+1];e&&e.move&&e.move.piece&&(b=e.move.piece.color!==P.humanColor)}P.redoMove()&&(P.selectedSquare=null,B.updateDisplay(),B.animateUndoRedo("redo",b),B.updatePlayerTurnIndicator(P.currentPlayer,P.gameMode),B.updateCapturedPiecesDisplay(),B.updateMoveHistoryDisplay(),await P.autoSave(),P.gameMode==="human-vs-bot"?(P.isBotTurn(),B.showBotThinking(!1),B.setInputEnabled(!0)):P.gameMode==="human-vs-human"&&B.setInputEnabled(!0))}else B.showInstructionLabel("Push button to enable undo")});window.addEventListener("scrollDown",async()=>{if(P&&B)if(P.allowUndo){let b=!1;if(P.gameMode==="human-vs-bot"&&P.currentStateIndex>0){const i=P.stateHistory[P.currentStateIndex];i&&i.move&&i.move.piece&&(b=i.move.piece.color!==P.humanColor)}P.undoMove()&&(P.selectedSquare=null,B.updateDisplay(),B.animateUndoRedo("undo",b),B.updatePlayerTurnIndicator(P.currentPlayer,P.gameMode),B.updateCapturedPiecesDisplay(),B.updateMoveHistoryDisplay(),await P.autoSave(),P.gameMode==="human-vs-bot"?(P.isBotTurn(),B.showBotThinking(!1),B.setInputEnabled(!0)):P.gameMode==="human-vs-human"&&B.setInputEnabled(!0))}else B.showInstructionLabel("Push button to enable undo")});let ye=0;const Fe=300;window.addEventListener("sideClick",()=>{const b=Date.now();b-ye<Fe||(ye=b,P&&B&&B.showOptionsMenu())});window.addEventListener("longPressStart",()=>{});window.addEventListener("longPressEnd",()=>{P&&B&&(B.clearSavedState(),P.newGame(),B.updateDisplay(),B.showMessage("New game started!"),we("new_game_started"))});window.onPluginMessage=function(b){if(b.data)try{const e=typeof b.data=="string"?JSON.parse(b.data):b.data}catch{}b.message};function we(b,e={}){if(typeof PluginMessageHandler<"u"){const i={message:`Chess game event: ${b}`,gameEvent:b,details:e,wantsR1Response:!1,wantsJournalEntry:!1};PluginMessageHandler.postMessage(JSON.stringify(i))}}function Ae(b,e,i=365){const n=new Date;n.setTime(n.getTime()+i*24*60*60*1e3);const o=typeof e=="string"?e:JSON.stringify(e),a=encodeURIComponent(o),l=`${b}=${a}; expires=${n.toUTCString()}; path=/; SameSite=Lax`;if(l.length>4096)try{localStorage.setItem(b,o);return}catch{}document.cookie=l}function Le(b){const e=b+"=",i=document.cookie.split(";");for(let n=0;n<i.length;n++){let o=i[n].trim();if(o.indexOf(e)===0)try{const a=decodeURIComponent(o.substring(e.length));try{return JSON.parse(a)}catch{return a}}catch{return null}}return null}async function te(b,e){if(!b||typeof b!="string"||e==null)return!1;if(window.creationStorage&&window.creationStorage.plain&&typeof window.creationStorage.plain.setItem=="function")try{const n=JSON.stringify(e),o=btoa(n);return await window.creationStorage.plain.setItem(b,o),!0}catch{}try{return Ae(b,e),!0}catch{}try{const n=JSON.stringify(e);return localStorage.setItem(b,n),!0}catch{}return!1}async function W(b){if(window.creationStorage&&window.creationStorage.plain&&typeof window.creationStorage.plain.getItem=="function")try{const i=await window.creationStorage.plain.getItem(b);if(i){const n=atob(i);return JSON.parse(n)}}catch{}try{const i=Le(b);if(i)return i}catch{}try{const i=localStorage.getItem(b);if(i)return JSON.parse(i)}catch{}return null}document.addEventListener("DOMContentLoaded",async()=>{typeof PluginMessageHandler>"u"&&window.addEventListener("keydown",a=>{a.code==="KeyP"&&(a.preventDefault(),window.dispatchEvent(new CustomEvent("sideClick"))),a.code==="ArrowLeft"&&(a.preventDefault(),window.dispatchEvent(new CustomEvent("scrollDown"))),a.code==="ArrowRight"&&(a.preventDefault(),window.dispatchEvent(new CustomEvent("scrollUp")))}),P=new De,B=new Te(P);const b=document.getElementById("color-group"),e=document.getElementById("difficulty-group"),i=document.getElementById("orientation-mode-group"),n=document.getElementById("undo-group");b&&(b.style.display="block"),e&&(e.style.display="block"),i&&(i.style.display="none"),n&&(n.style.display="block"),await B.loadGameState()?(B.updateDisplay(),B.updateCapturedPiecesDisplay(),B.gameStatusElement.textContent="Game resumed",setTimeout(()=>{B.gameStatusElement.textContent=""},2e3)):(P.newGame(),B.updateDisplay()),B.updateCapturedPiecesDisplay(),we("game_initialized",{theme:P.theme,currentPlayer:P.currentPlayer})});window.addEventListener("beforeunload",b=>{});window.addEventListener("unload",b=>{});window.addEventListener("visibilitychange",()=>{});
